<!DOCTYPE html>
<html>
   <head>
       <meta charset="utf-8">
       <script src=
  "http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
       <script type="text/javascript">
           var start, end;
           var ELEMENT_VALUE = '3'; 
           function validData(d) {
               //for(var i in d) if(d[i] !== ELEMENT_VALUE) return false;
               return true;
           }
           function formatSize(sz) {
               if(sz < 1) return "-";
               if(sz < 1024) {
                return sz + " bytes";
               } else if(sz >= 1024 && sz < 1024*1024) {
                  return (sz / 1024).toFixed(2) + " kB";
               } else if(sz >= 1024 * 1024) {
                  return (sz / (1024 * 1024)).toFixed(2) + " MB";
               }
           }
           $(function() {

               var binary = false;   

               window.WebSocket = window.WebSocket || window.MozWebSocket;

               var websocket = new WebSocket('ws://127.0.0.1:9001',
                                             'myprotocol-async');

               websocket.binaryType = "arraybuffer";

               websocket.onopen = function () {
                   $('h1').css('color', 'green');
               };

               websocket.onerror = function (e) {
                   $('h1').css('color', 'red');
                   console.log(e.msg);
               };
               websocket.onmessage = function (e) {
                   var length = binary ? e.data.byteLength : e.data.length;
                   end = performance.now();
                   var msg = "Round-trip time: " 
                             + (end - start).toFixed(0)
                             + " ms";
                   msg += "<br/>";          
                   msg += "Received size: " + formatSize(length)
                   if(length >= 1024) 
                       msg += " (" + length + " bytes)" ;

                   $('div').css('font-family', 'Courier New');
                   if(validData(e.data)) $('div').css('color', 'blue');
                   else $('div').css('color', 'red');
                   $('div').append($('<p>', { html:  msg }));

               };
               function sendText(sz) {
                    binary = false; 
                    var buffer = new Array(); 

                    for(var i = 0; i < sz; i++) buffer[i] = ELEMENT_VALUE;
                   //websocket.send();
                    var sbuf = buffer.join("");   
                    start = performance.now(); 
                    websocket.send(sbuf);
               }
               function sendBinary(sz) {
                    binary = true;
                    var sbuf = new Uint8Array(sz);
                    for(var i = 0; i < sz; i++) sbuf[i] = 17;//ELEMENT_VALUE;
                    start = performance.now(); 
                    websocket.send(sbuf);
               }
               $('button').click(function(e) {
                  try {
                      e.preventDefault();
                      //warning: Chrome 33.0.1750.117 has a websocket output size
                      //limit of 64kb
                      if($('input').val().length == 0) return;  
                      var m = parseInt($('input').val());
                      if(m < 1) {
                          alert("Size must be > 0");
                          return;
                      }
                      if(($("[name='binary']").prop('checked'))) {
                          sendBinary(m);    
                      } else {
                          sendText(m); 
                      }
                 } catch(except) {
                    console.log(except.msg);
                 }
               });
           });
       </script>
       </head>
   <body>
       <h1>WebSockets test</h1>
       <form>
           <p>Enter message size:</p>
           <input type="text" />
           <input type="checkbox" name="binary" value="binary"/>
           <button>Send</button>
       </form>
       <div></div>
   </body>
</html>

