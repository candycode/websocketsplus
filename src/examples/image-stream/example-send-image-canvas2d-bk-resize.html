<!--
Websockets+ : C++11 server-side websocket library based on libwebsockets;
              supports easy creation of services and built-in throttling
Copyright (C) 2014  Ugo Varetto

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<!DOCTYPE html>
<html>
   <head>
       <meta charset="utf-8">
       <script src=
  "http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
       <script type="text/javascript">
          
          $(function() {
              window.WebSocket = window.WebSocket || window.MozWebSocket;
              //var MIME_TYPE = "image/jpeg";
              //var MIME_TYPE = "image/png";
              var MIME_TYPE = "image/webp"; //"image/webp" for Chrome only
              //var MIME_TYPE = "";
              var out = $("[name='output']");
              var bytes = $("[name='bytes']");
              var img = new Image();
              var blob = new Blob( [], { type: MIME_TYPE } );
              var urlCreator = window.URL || window.webkitURL;
              var imageUrl;
              var canvas = document.querySelector( "#canvas" );
              var WIDTH = 1920;
              var HEIGHT = 1080;
              var context = canvas.getContext('2d');
              var maintainAspectRatio = true;
              var ratio = 1080 / 1920;
              
              //canvas.width = WIDTH;
              //canvas.height = HEIGHT;
              context.fillStyle = "grey";
              context.fillRect(0,0,WIDTH,HEIGHT);
               
              img.onload = function() {
                context.drawImage(img, 0, 0);
              }  
              
              var websocket = new WebSocket('ws://127.0.0.1:5000',
                                            'image-stream');
              websocket.binaryType = "arraybuffer";
             

              function resizeCanvas() {
                var width = window.innerWidth;
                var height = window.innerHeight;

                if(width > height) {
                  canvas.height = height;
                  canvas.width = canvas.height / ratio;
                 
                } else {
                   canvas.width = width;
                  canvas.height = canvas.width * ratio;
                }  
                var w = canvas.width / WIDTH;
                var h = canvas.height / HEIGHT;     
                context.scale(w, h);
                alert(w + " " + h + " " + (width / WIDTH));
              }
              window.addEventListener('resize', resizeCanvas, true);  

              websocket.onopen = function () {
                  $('h1').css('color', 'green');
              };

              websocket.onerror = function (e) {
                $('h1').css('color', 'red');
                console.log(e);
              };
              var start = performance.now();
              var elapsed = 0;
              var frames = 0;
              websocket.onmessage = function (e) {
                if(imageUrl)
                  urlCreator.revokeObjectURL(imageUrl);
                if(!e) return;
                if(!e.data) return;
                if(e.data.byteLength < 1) return;
                frames++;
                elapsed = performance.now() - start;
                bytes.text(e.data.byteLength);
                out.text((1000 * frames / elapsed).toFixed(0));
                blob = new Blob([e.data], {type: MIME_TYPE});
                if(!blob) return;
                imageUrl = urlCreator.createObjectURL( blob );
                if(!imageUrl) return;
                img.src = imageUrl;
              };
              resizeCanvas();
           });
       </script>
       </head>
   <body>
    <div style="color: red; font-size: 300%">
       <h1>WebSockets stream test</h1>
       <div>Frame/s: <span name="output"></span></div>
       <div>Size: <span name="bytes"></span> bytes</div>
       <div><!--width="1920" height="1080"-->
    </div>
    <canvas id="canvas" 
                style="z-index: -1;position:fixed; top:0;left:0"></canvas></div>            
   </body>
</html>

